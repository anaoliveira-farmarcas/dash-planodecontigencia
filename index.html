<script type="module">
        // 1. IMPORTAÃ‡ÃƒO CORRETA (Links completos para funcionar no navegador)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. SUA CONFIGURAÃ‡ÃƒO COMPLETA (Adicionei a linha databaseURL que faltava)
        const firebaseConfig = {
            apiKey: "AIzaSyALfPIUw9lc_zkHlSZ6Y2xRdcTu0awhdzM",
            authDomain: "dashboardprojetos-a749c.firebaseapp.com",
            // ðŸ‘‡ ESTA LINHA Ã‰ OBRIGATÃ“RIA PARA O SITE FUNCIONAR ðŸ‘‡
            databaseURL: "https://dashboardprojetos-a749c-default-rtdb.firebaseio.com",
            projectId: "dashboardprojetos-a749c",
            storageBucket: "dashboardprojetos-a749c.firebasestorage.app",
            messagingSenderId: "208429748638",
            appId: "1:208429748638:web:9d5ee72514035221b3c68f"
        };

        // Inicializa o App
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'dashboard_projetos_v1');

        // --- VARIÃVEIS DO SISTEMA ---
        let allStoresData = []; 
        let allFlattenedData = [];
        let currentChartInstance = null; 
        let consolidatedChartInstance = null;
        let currentChartRowData = null;

        const projectList = ["MIX DE PRODUTOS", "PRECIFICAÃ‡ÃƒO", "PBM", "PEC", "SETORIZAÃ‡ÃƒO (ESTACIONAMENTO)", "MARCAS PROPRIAS", "GC (FARMACINHA)", "DELIVERY (E-DELIVERY)", "INSPIRE +", "DERMACLUB", "SERVIÃ‡OS FARMACEUTICOS", "CAMPANHA IDOSO", "MEDICAMENTOS ESPECIAIS", "FIDELIZA MAIS"];
        const statusList = [{val:'pendente', txt:'Pendente', cls:'status-pendente'}, {val:'andamento', txt:'Em Andamento', cls:'status-andamento'}, {val:'pendente-associa', txt:'Pendente Assoc.', cls:'status-pendente-associa'}, {val:'finalizado', txt:'Finalizado', cls:'status-finalizado'}];
        const indicatorMonths = [
            { id: 'aug2025', label: 'Ago/25' }, { id: 'sep2025', label: 'Set/25' }, { id: 'oct2025', label: 'Out/25' },
            { id: 'nov2025', label: 'Nov/25' }, { id: 'dec2025', label: 'Dez/25' }, { id: 'jan2026', label: 'Jan/26' },
            { id: 'feb2026', label: 'Fev/26' }, { id: 'mar2026', label: 'Mar/26' }, { id: 'apr2026', label: 'Abr/26' },
            { id: 'may2026', label: 'Mai/26' }, { id: 'jun2026', label: 'Jun/26' }, { id: 'jul2026', label: 'Jul/26' },
            { id: 'aug2026', label: 'Ago/26' }, { id: 'sep2026', label: 'Set/26' }, { id: 'oct2026', label: 'Out/26' },
            { id: 'nov2026', label: 'Nov/26' }, { id: 'dec2026', label: 'Dez/26' }
        ];
        const chartLabels = indicatorMonths.map(m => m.label);

        // Elementos da Tela
        const els = {
            tableBody: document.getElementById('project-table-body'),
            toast: document.getElementById('toast'),
            storeModal: document.getElementById('store-modal'),
            storeForm: document.getElementById('store-form'),
            chartModal: document.getElementById('chart-modal'),
            obsModal: document.getElementById('obs-modal'),
            deleteModal: document.getElementById('delete-confirm-modal'),
            sidebar: document.getElementById('filter-sidebar'),
            mainContent: document.getElementById('main-content'),
            searchInput: document.getElementById('search-input'),
            kpis: {
                total: document.getElementById('kpi-total-lojas'),
                pendente: document.getElementById('kpi-projetos-pendentes'),
                associa: document.getElementById('kpi-projetos-pendentes-associa'),
                finalizado: document.getElementById('kpi-projetos-finalizados'),
                andamento: document.getElementById('kpi-em-andamento')
            },
            filters: {
                analista: document.getElementById('filter-analista'),
                ge: document.getElementById('filter-ge'),
                associado: document.getElementById('filter-associado'),
                uf: document.getElementById('filter-uf'),
                anjo: document.getElementById('filter-anjo'),
                bandeira: document.getElementById('filter-bandeira'),
                projeto: document.getElementById('filter-projeto'),
                cnpj: document.getElementById('filter-cnpj'),
                loja: document.getElementById('filter-loja')
            }
        };

        // --- CONEXÃƒO COM O BANCO ---
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            allStoresData = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            processData();
            showToast("Conectado!", false, 1500);
        }, (error) => {
            console.error("Erro Firebase:", error);
            showToast("Erro de ConexÃ£o. Banco criado?", true, 5000);
        });

        function saveToFirebase(newData) {
            set(dbRef, newData).catch(err => {
                console.error(err);
                showToast("Erro ao salvar! PermissÃ£o negada?", true);
            });
        }

        // --- LÃ“GICA DO SISTEMA ---
        function processData() {
            allFlattenedData = [];
            const sets = { analistas: new Set(), ges: new Set(), associados: new Set(), anjos: new Set(), ufs: new Set(), bandeiras: new Set() };
            
            allStoresData.forEach(store => {
                if(!store) return;
                sets.analistas.add(store.analista); sets.ges.add(store.ge);
                sets.associados.add(store.associado); sets.anjos.add(store.anjo);
                sets.ufs.add(store.uf); sets.bandeiras.add(store.bandeira);

                if(store.projects) {
                    Object.keys(store.projects).forEach(pName => {
                        const p = store.projects[pName];
                        allFlattenedData.push({ ...store, projectName: pName, ...p, projects: undefined });
                    });
                }
            });
            
            allFlattenedData.sort((a,b) => a.nomeLoja.localeCompare(b.nomeLoja));
            populateFilters(sets);
            loadFilters();
            applyFilters();
            calcKPIs();
        }

        function populateFilters(sets) {
            const fill = (el, set) => {
                const cur = el.value;
                el.innerHTML = '<option value="">Todos</option>';
                [...set].sort().forEach(v => v && el.add(new Option(v, v)));
                el.value = cur;
            };
            fill(els.filters.analista, sets.analistas); fill(els.filters.ge, sets.ges);
            fill(els.filters.associado, sets.associados); fill(els.filters.uf, sets.ufs);
            fill(els.filters.anjo, sets.anjos); fill(els.filters.bandeira, sets.bandeiras);
            
            const chartGe = document.getElementById('chart-filter-ge');
            const curGe = chartGe.value;
            chartGe.innerHTML = '<option value="">Todos</option>';
            [...sets.ges].sort().forEach(v => v && chartGe.add(new Option(v, v)));
            chartGe.value = curGe;
        }

        function applyFilters() {
            const s = els.searchInput.value.toLowerCase();
            const f = els.filters;
            
            const filtered = allFlattenedData.filter(r => {
                const matchesSearch = !s || r.nomeLoja.toLowerCase().includes(s) || r.id.toLowerCase().includes(s);
                return matchesSearch &&
                    (!f.analista.value || r.analista === f.analista.value) &&
                    (!f.ge.value || r.ge === f.ge.value) &&
                    (!f.associado.value || r.associado === f.associado.value) &&
                    (!f.uf.value || r.uf === f.uf.value) &&
                    (!f.anjo.value || r.anjo === f.anjo.value) &&
                    (!f.bandeira.value || r.bandeira === f.bandeira.value) &&
                    (!f.projeto.value || r.projectName === f.projeto.value) &&
                    (!f.cnpj.value || r.id.toLowerCase().includes(f.cnpj.value.toLowerCase())) &&
                    (!f.loja.value || r.nomeLoja.toLowerCase().includes(f.loja.value.toLowerCase()));
            });
            renderTable(filtered);
        }

        function renderTable(data) {
            els.tableBody.innerHTML = '';
            if(!data.length) { els.tableBody.innerHTML = '<tr><td colspan="29" class="p-8 text-center text-gray-500">Nenhum projeto encontrado.</td></tr>'; return; }

            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                
                const statusOpts = statusList.map(s => `<option value="${s.val}" ${r.status===s.val?'selected':''}>${s.txt}</option>`).join('');
                const statusClass = statusList.find(s=>s.val===r.status)?.cls || 'status-default';
                const obsClass = (r.observation && r.observation.trim()) ? 'obs-filled' : 'text-gray-400';
                
                const inputs = indicatorMonths.map(m => 
                    `<td class="px-2 py-2 text-center"><input type="number" class="indicator-input-table" value="${r.indicators?.[m.id]||''}" placeholder="-" data-id="${r.id}" data-p="${r.projectName}" data-m="${m.id}"></td>`
                ).join('');

                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium whitespace-nowrap">${r.nomeLoja}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.id}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.analista||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.ge||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.associado||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.bandeira||'-'}</td>
                    <td class="px-4 py-3 font-bold text-gray-800 text-xs">${r.projectName}</td>
                    <td class="px-4 py-3 text-center"><select class="status-select ${statusClass} text-xs" data-id="${r.id}" data-p="${r.projectName}">${statusOpts}</select></td>
                    <td class="px-4 py-2 text-center"><input type="number" class="indicator-input-table meta-input" value="${r.goal||''}" placeholder="-" data-id="${r.id}" data-p="${r.projectName}"></td>
                    ${inputs}
                    <td class="px-4 py-3 text-center"><button class="view-obs-btn ${obsClass}" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-note-sticky"></i></button></td>
                    <td class="px-4 py-3 text-center flex gap-2 justify-center">
                        <button class="edit-btn text-blue-500" data-id="${r.id}"><i class="fa-solid fa-pencil"></i></button>
                        <button class="chart-btn text-[#FF5510]" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-chart-line"></i></button>
                        <button class="del-btn text-red-500" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                els.tableBody.appendChild(tr);
            });

            els.tableBody.querySelectorAll('select').forEach(el => el.addEventListener('change', updateStatus));
            els.tableBody.querySelectorAll('.indicator-input-table:not(.meta-input)').forEach(el => el.addEventListener('change', updateIndicator)); 
            els.tableBody.querySelectorAll('.meta-input').forEach(el => el.addEventListener('change', updateMeta));
            els.tableBody.querySelectorAll('.view-obs-btn').forEach(el => el.addEventListener('click', openObs));
            els.tableBody.querySelectorAll('.chart-btn').forEach(el => el.addEventListener('click', openChart));
            els.tableBody.querySelectorAll('.del-btn').forEach(el => el.addEventListener('click', confirmDel));
            els.tableBody.querySelectorAll('.edit-btn').forEach(el => el.addEventListener('click', editStore));
        }

        function updateGeneric(id, pName, fn) {
            const clone = JSON.parse(JSON.stringify(allStoresData));
            const idx = clone.findIndex(s => s && s.id === id);
            if(idx > -1 && clone[idx].projects[pName]) {
                fn(clone[idx].projects[pName]);
                saveToFirebase(clone);
            }
        }

        function updateStatus(e) {
            const el = e.target;
            updateGeneric(el.dataset.id, el.dataset.p, (proj) => proj.status = el.value);
            el.className = `status-select ${statusList.find(s=>s.val===el.value)?.cls||'status-default'} text-xs`;
        }

        function updateIndicator(e) {
            const el = e.target;
            updateGeneric(el.dataset.id, el.dataset.p, (proj) => {
                if(!proj.indicators) proj.indicators = {};
