<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Integrado - Farmarcas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f3f4f6; }
        
        /* Estilos do Código Original */
        .status-select {
            padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-weight: 500;
            appearance: none; -webkit-appearance: none;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e") no-repeat right 8px center / 14px;
        }
        .status-default { background-color: #f3f4f6; color: #4b5563; }
        .status-pendente { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-andamento { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .status-pendente-associa { background-color: #fef9c3; color: #a16207; border-color: #fde047; }
        .status-finalizado { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        
        .indicator-input-table { width: 70px; padding: 4px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; background-color: #f9fafb; transition: all 0.2s; }
        .indicator-input-table:focus { outline: none; border-color: #FF5510; background-color: #fff; box-shadow: 0 0 0 2px rgba(255, 85, 16, 0.2); }
        
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        #toast { transition: transform 0.3s, opacity 0.3s; }
        .obs-filled { color: #3b82f6; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Estilos adicionais para o menu de navegação */
        .nav-item { cursor: pointer; transition: all 0.2s; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; color: #4b5563; }
        .nav-item:hover { background-color: #f3f4f6; color: #FF5510; }
        .nav-item.active { background-color: #fff7ed; color: #FF5510; font-weight: 600; border-left: 4px solid #FF5510; }
        .nav-item i { width: 24px; text-align: center; margin-right: 12px; }

        /* Estilos para o React Modal Overlay (Código 2) */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 60; }
        
        /* Ajuste de fonte para a área do React */
        #react-root { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <aside id="filter-sidebar" class="fixed top-0 left-0 z-50 w-72 h-screen bg-white shadow-lg p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col">
        <h3 class="text-2xl font-extrabold text-[#FF5510] mb-8 px-2">Farmarcas <span class="text-gray-400 text-sm block font-normal">Dashboard</span></h3>
        
        <nav class="mb-8">
            <ul>
                <li id="tab-dashboard" class="nav-item active" onclick="switchTab('dashboard')">
                    <i class="fa-solid fa-chart-pie"></i> Dashboard Geral
                </li>
                <li id="tab-piloto" class="nav-item" onclick="switchTab('piloto')">
                    <i class="fa-solid fa-flask"></i> Projeto Piloto
                </li>
            </ul>
        </nav>

        <hr class="border-gray-200 mb-6">

        <div id="sidebar-filters-container">
            <h3 class="text-sm font-bold text-gray-500 uppercase mb-4 px-2">Filtros Dashboard</h3>
            <div class="space-y-3 overflow-y-auto h-[calc(100vh-380px)] pr-2 custom-scroll">
                <div><label class="block text-xs font-medium text-gray-500">Analista</label><select id="filter-analista" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                <div><label class="block text-xs font-medium text-gray-500">GE</label><select id="filter-ge" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                <div><label class="block text-xs font-medium text-gray-500">Associado</label><select id="filter-associado" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                <div><label class="block text-xs font-medium text-gray-500">UF</label><select id="filter-uf" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                <div><label class="block text-xs font-medium text-gray-500">Projeto</label><select id="filter-projeto" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                <div><label class="block text-xs font-medium text-gray-500">CNPJ / Loja</label><input type="text" id="filter-loja" class="mt-1 block w-full rounded border-gray-300 text-sm" placeholder="Busca rápida..."></div>
            </div>
            <div class="mt-4 space-y-2">
                <button id="apply-filters-btn" class="w-full bg-[#FF5510] text-white py-2 rounded text-sm font-semibold hover:bg-[#E04A0E]">Aplicar</button>
                <button id="clear-filters-btn" class="w-full bg-gray-100 text-gray-600 py-2 rounded text-sm hover:bg-gray-200">Limpar</button>
            </div>
        </div>
    </aside>

    <main id="main-content" class="md:ml-72 transition-all duration-300 p-2 md:p-6 min-h-screen">
        
        <div class="md:hidden mb-4">
            <button id="toggle-filter-btn" class="text-gray-600 p-2 bg-white rounded shadow"><i class="fa-solid fa-bars"></i> Menu</button>
        </div>

        <div id="view-dashboard">
            <header class="mb-6">
                <nav class="bg-white rounded-lg shadow-sm p-4 flex justify-between items-center mb-6 border-l-4 border-[#FF5510]">
                    <h1 class="text-2xl font-extrabold text-gray-800">Visão Geral</h1>
                    <button id="open-modal-btn" class="bg-[#FF5510] text-white py-2 px-4 rounded-lg font-semibold hover:bg-[#E04A0E] flex items-center space-x-2 text-sm shadow">
                        <i class="fa-solid fa-plus"></i><span>Inserir Loja</span>
                    </button>
                </nav>
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-black">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Total</h4><p id="kpi-total-lojas" class="text-2xl font-extrabold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-red-500">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Pendentes</h4><p id="kpi-projetos-pendentes" class="text-2xl font-extrabold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-yellow-400">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Pend. Assoc.</h4><p id="kpi-projetos-pendentes-associa" class="text-2xl font-extrabold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-blue-500">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Andamento</h4><p id="kpi-em-andamento" class="text-2xl font-extrabold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-green-500">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Finalizados</h4><p id="kpi-projetos-finalizados" class="text-2xl font-extrabold text-gray-800">0</p>
                    </div>
                </div>
            </header>

            <section class="mb-6 bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Evolução Mensal</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 items-end">
                    <div><label class="block text-xs font-medium text-gray-500">Projeto</label><select id="chart-filter-project" class="mt-1 block w-full rounded border-gray-300 text-sm"></select></div>
                    <div><label class="block text-xs font-medium text-gray-500">GE</label><select id="chart-filter-ge" class="mt-1 block w-full rounded border-gray-300 text-sm"><option value="">Todos</option></select></div>
                    <div><label class="block text-xs font-medium text-gray-500">Busca</label><input type="text" id="chart-filter-cnpj-loja" class="mt-1 block w-full rounded border-gray-300 text-sm" placeholder="CNPJ ou Loja"></div>
                    <button id="generate-chart-btn" class="bg-gray-800 text-white py-2 px-4 rounded text-sm font-semibold hover:bg-black h-[38px] w-full">Gerar Gráfico</button>
                </div>
                <div class="relative h-72"><canvas id="consolidated-chart"></canvas></div>
            </section>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-3 border-b flex items-center">
                    <i class="fa-solid fa-search text-gray-400 mr-2"></i>
                    <input type="text" id="search-input" placeholder="Pesquisar na tabela..." class="w-full outline-none text-sm text-gray-700">
                </div>
                <div class="overflow-x-auto max-h-[calc(100vh-320px)]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Loja</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">CNPJ</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Analista</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">GE</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Assoc.</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Bandeira</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Projeto</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Meta</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/25</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/25</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/25</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/25</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/25</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jan/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Fev/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mar/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Abr/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Mai/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jun/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Jul/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ago/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Set/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Out/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nov/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Dez/26</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Obs</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="29" class="text-center p-8 text-gray-500">Conectando ao Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-piloto" class="hidden">
            <div id="react-root"></div>
        </div>

    </main>

    <div id="toast" class="fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 z-[100]">Msg</div>

    <div id="store-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <header class="flex justify-between items-center p-5 border-b">
                <h2 id="store-modal-title" class="text-xl font-extrabold text-gray-800">Loja</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-times fa-lg"></i></button>
            </header>
            <form id="store-form" class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Nome Loja</label><input type="text" name="nome-loja" required class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">CNPJ (ID)</label><input type="text" id="cnpj" name="cnpj" required class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">Analista</label><input type="text" id="analista" name="analista" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">GE</label><input type="text" id="ge" name="ge" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">Associado</label><input type="text" id="associado" name="associado" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium">Bandeira</label><input type="text" id="bandeira" name="bandeira" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">UF</label><input type="text" id="uf" name="uf" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">Anjo</label><input type="text" id="anjo" name="anjo" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        
                        <div id="form-project-group">
                            <label class="block text-sm font-medium">Projeto</label>
                            <select id="nome-projeto" name="nome-projeto" required class="mt-1 block w-full rounded border-gray-300 shadow-sm">
                                <option value="" disabled selected>Carregando projetos...</option>
                            </select>
                        </div>
                        
                        <div id="form-meta-group"><label class="block text-sm font-medium">Meta</label><input type="number" name="meta" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></div>
                        <div id="form-observation-group"><label class="block text-sm font-medium">Obs</label><textarea name="observation" rows="3" class="mt-1 block w-full rounded border-gray-300 shadow-sm"></textarea></div>
                    </div>
                </div>
            </form>
            <footer class="flex justify-end p-5 border-t bg-gray-50">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-700 py-2 px-5 rounded mr-3">Cancelar</button>
                <button id="save-store-btn" type="submit" form="store-form" class="bg-[#FF5510] text-white py-2 px-5 rounded shadow">Salvar</button>
            </footer>
        </div>
    </div>

    <div id="chart-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <header class="flex justify-between items-center p-5 border-b">
                <h2 id="chart-modal-title" class="text-xl font-bold">Gráfico</h2>
                <button id="close-chart-modal-btn" class="text-gray-500"><i class="fa-solid fa-times"></i></button>
            </header>
            <div class="p-6">
                <div class="mb-4 flex justify-center space-x-6">
                    <label><input type="radio" name="chart-format" value="number" checked class="mr-2">Número</label>
                    <label><input type="radio" name="chart-format" value="currency" class="mr-2">Moeda</label>
                    <label><input type="radio" name="chart-format" value="percent" class="mr-2">%</label>
                </div>
                <canvas id="indicator-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="obs-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <header class="flex justify-between items-center p-5 border-b"><h2 id="obs-modal-title" class="font-bold">Obs</h2></header>
            <div class="p-6"><textarea id="obs-modal-textarea" rows="8" class="w-full border rounded"></textarea></div>
            <footer class="flex justify-end p-5 border-t"><button id="cancel-obs-btn" class="bg-gray-200 px-4 py-2 rounded mr-2">Cancelar</button><button id="save-obs-btn" class="bg-[#FF5510] text-white px-4 py-2 rounded">Salvar</button></footer>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">Excluir?</h2>
            <p id="delete-modal-text" class="mb-6">Tem certeza?</p>
            <div class="flex justify-end"><button id="cancel-delete-btn" class="bg-gray-200 px-4 py-2 rounded mr-3">Não</button><button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded">Sim</button></div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Atualiza classes do menu
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // Alterna visibilidade das views
            const dashboardView = document.getElementById('view-dashboard');
            const pilotoView = document.getElementById('view-piloto');
            const sidebarFilters = document.getElementById('sidebar-filters-container');

            if (tabName === 'dashboard') {
                dashboardView.classList.remove('hidden');
                pilotoView.classList.add('hidden');
                sidebarFilters.style.display = 'block'; // Mostra filtros da sidebar
            } else {
                dashboardView.classList.add('hidden');
                pilotoView.classList.remove('hidden');
                sidebarFilters.style.display = 'none'; // Esconde filtros pois o Piloto tem filtros próprios
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyALfPIUw9lc_zkHlSZ6Y2xRdcTu0awhdzM",
            authDomain: "dashboardprojetos-a749c.firebaseapp.com",
            databaseURL: "https://dashboardprojetos-a749c-default-rtdb.firebaseio.com",
            projectId: "dashboardprojetos-a749c",
            storageBucket: "dashboardprojetos-a749c.firebasestorage.app",
            messagingSenderId: "208429748638",
            appId: "1:208429748638:web:9d5ee72514035221b3c68f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'dashboard_projetos_v1');

        const projectList = [
            "MIX DE PRODUTOS", "PRECIFICAÇÃO", "PBM", "PEC", 
            "SETORIZAÇÃO (ESTACIONAMENTO)", "MARCAS PROPRIAS", 
            "GC (FARMACINHA)", "DELIVERY (E-DELIVERY)", "INSPIRE +", 
            "DERMACLUB", "SERVIÇOS FARMACEUTICOS", "CAMPANHA IDOSO", 
            "MEDICAMENTOS ESPECIAIS", "FIDELIZA MAIS"
        ];
        
        function initDropdowns() {
            const pSelects = [
                document.getElementById('filter-projeto'), 
                document.getElementById('chart-filter-project'), 
                document.getElementById('nome-projeto')
            ];
            
            pSelects.forEach(sel => {
                if(!sel) return;
                if (sel.id === 'nome-projeto') {
                    sel.innerHTML = '<option value="" disabled selected>Selecione um projeto</option>';
                } else {
                    sel.innerHTML = '<option value="">Todos os Projetos</option>';
                }
                projectList.forEach(p => sel.add(new Option(p, p)));
            });
        }
        initDropdowns();

        let allStoresData = []; 
        let allFlattenedData = [];
        let currentChartInstance = null; 
        let consolidatedChartInstance = null;
        let currentChartRowData = null;

        const statusList = [{val:'pendente', txt:'Pendente', cls:'status-pendente'}, {val:'andamento', txt:'Em Andamento', cls:'status-andamento'}, {val:'pendente-associa', txt:'Pendente Assoc.', cls:'status-pendente-associa'}, {val:'finalizado', txt:'Finalizado', cls:'status-finalizado'}];
        const indicatorMonths = [
            { id: 'aug2025', label: 'Ago/25' }, { id: 'sep2025', label: 'Set/25' }, { id: 'oct2025', label: 'Out/25' },
            { id: 'nov2025', label: 'Nov/25' }, { id: 'dec2025', label: 'Dez/25' }, { id: 'jan2026', label: 'Jan/26' },
            { id: 'feb2026', label: 'Fev/26' }, { id: 'mar2026', label: 'Mar/26' }, { id: 'apr2026', label: 'Abr/26' },
            { id: 'may2026', label: 'Mai/26' }, { id: 'jun2026', label: 'Jun/26' }, { id: 'jul2026', label: 'Jul/26' },
            { id: 'aug2026', label: 'Ago/26' }, { id: 'sep2026', label: 'Set/26' }, { id: 'oct2026', label: 'Out/26' },
            { id: 'nov2026', label: 'Nov/26' }, { id: 'dec2026', label: 'Dez/26' }
        ];
        const chartLabels = indicatorMonths.map(m => m.label);

        const els = {
            tableBody: document.getElementById('project-table-body'),
            toast: document.getElementById('toast'),
            storeModal: document.getElementById('store-modal'),
            storeForm: document.getElementById('store-form'),
            chartModal: document.getElementById('chart-modal'),
            obsModal: document.getElementById('obs-modal'),
            deleteModal: document.getElementById('delete-confirm-modal'),
            sidebar: document.getElementById('filter-sidebar'),
            mainContent: document.getElementById('main-content'),
            searchInput: document.getElementById('search-input'),
            kpis: {
                total: document.getElementById('kpi-total-lojas'),
                pendente: document.getElementById('kpi-projetos-pendentes'),
                associa: document.getElementById('kpi-projetos-pendentes-associa'),
                finalizado: document.getElementById('kpi-projetos-finalizados'),
                andamento: document.getElementById('kpi-em-andamento')
            },
            filters: {
                analista: document.getElementById('filter-analista'),
                ge: document.getElementById('filter-ge'),
                associado: document.getElementById('filter-associado'),
                uf: document.getElementById('filter-uf'),
                // anjo: document.getElementById('filter-anjo'), // Removido da sidebar no layout unificado para economizar espaço
                // bandeira: document.getElementById('filter-bandeira'),
                projeto: document.getElementById('filter-projeto'),
                // cnpj: document.getElementById('filter-cnpj'),
                loja: document.getElementById('filter-loja')
            }
        };

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            allStoresData = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            processData();
            showToast("Sincronizado!", false, 1500);
        }, (error) => {
            console.error("Erro Firebase:", error);
            showToast("Erro: Permissão negada ou Banco inexistente!", true, 5000);
        });

        function saveToFirebase(newData) {
            set(dbRef, newData).catch(err => {
                console.error(err);
                showToast("Erro ao salvar dados!", true);
            });
        }

        function processData() {
            allFlattenedData = [];
            const sets = { analistas: new Set(), ges: new Set(), associados: new Set(), anjos: new Set(), ufs: new Set(), bandeiras: new Set() };
            
            allStoresData.forEach(store => {
                if(!store) return;
                if(store.analista) sets.analistas.add(store.analista);
                if(store.ge) sets.ges.add(store.ge);
                if(store.associado) sets.associados.add(store.associado);
                if(store.anjo) sets.anjos.add(store.anjo);
                if(store.uf) sets.ufs.add(store.uf);
                if(store.bandeira) sets.bandeiras.add(store.bandeira);

                if(store.projects) {
                    Object.keys(store.projects).forEach(pName => {
                        const p = store.projects[pName];
                        allFlattenedData.push({ ...store, projectName: pName, ...p, projects: undefined });
                    });
                }
            });
            
            allFlattenedData.sort((a,b) => a.nomeLoja.localeCompare(b.nomeLoja));
            populateFilters(sets);
            loadFilters();
            applyFilters();
            calcKPIs();
        }

        function populateFilters(sets) {
            const fill = (el, set) => {
                if(!el) return;
                const cur = el.value;
                el.innerHTML = '<option value="">Todos</option>';
                [...set].sort().forEach(v => v && el.add(new Option(v, v)));
                el.value = cur;
            };
            fill(els.filters.analista, sets.analistas); fill(els.filters.ge, sets.ges);
            fill(els.filters.associado, sets.associados); fill(els.filters.uf, sets.ufs);
            
            const chartGe = document.getElementById('chart-filter-ge');
            const curGe = chartGe.value;
            chartGe.innerHTML = '<option value="">Todos</option>';
            [...sets.ges].sort().forEach(v => v && chartGe.add(new Option(v, v)));
            chartGe.value = curGe;
        }

        function applyFilters() {
            const s = els.searchInput.value.toLowerCase();
            const f = els.filters;
            
            const filtered = allFlattenedData.filter(r => {
                // Adaptação para o filtro de texto unificado
                const textFilter = f.loja.value.toLowerCase();
                const matchesText = !textFilter || r.nomeLoja.toLowerCase().includes(textFilter) || r.id.toLowerCase().includes(textFilter);

                const matchesSearch = !s || r.nomeLoja.toLowerCase().includes(s) || r.id.toLowerCase().includes(s);
                return matchesSearch && matchesText &&
                    (!f.analista.value || r.analista === f.analista.value) &&
                    (!f.ge.value || r.ge === f.ge.value) &&
                    (!f.associado.value || r.associado === f.associado.value) &&
                    (!f.uf.value || r.uf === f.uf.value) &&
                    (!f.projeto.value || r.projectName === f.projeto.value);
            });
            renderTable(filtered);
        }

        function renderTable(data) {
            els.tableBody.innerHTML = '';
            if(!data.length) { 
                if(allFlattenedData.length === 0) {
                    els.tableBody.innerHTML = '<tr><td colspan="29" class="p-8 text-center text-gray-500">Banco de dados vazio. Clique em "Inserir Loja" para começar!</td></tr>';
                } else {
                    els.tableBody.innerHTML = '<tr><td colspan="29" class="p-8 text-center text-gray-500">Nenhum projeto encontrado com estes filtros.</td></tr>'; 
                }
                return; 
            }

            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                
                const statusOpts = statusList.map(s => `<option value="${s.val}" ${r.status===s.val?'selected':''}>${s.txt}</option>`).join('');
                const statusClass = statusList.find(s=>s.val===r.status)?.cls || 'status-default';
                const obsClass = (r.observation && r.observation.trim()) ? 'obs-filled' : 'text-gray-400';
                
                const inputs = indicatorMonths.map(m => 
                    `<td class="px-2 py-2 text-center"><input type="number" class="indicator-input-table" value="${r.indicators?.[m.id]||''}" placeholder="-" data-id="${r.id}" data-p="${r.projectName}" data-m="${m.id}"></td>`
                ).join('');

                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium whitespace-nowrap">${r.nomeLoja}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.id}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.analista||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.ge||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.associado||'-'}</td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${r.bandeira||'-'}</td>
                    <td class="px-4 py-3 font-bold text-gray-800 text-xs">${r.projectName}</td>
                    <td class="px-4 py-3 text-center"><select class="status-select ${statusClass} text-xs" data-id="${r.id}" data-p="${r.projectName}">${statusOpts}</select></td>
                    <td class="px-4 py-2 text-center"><input type="number" class="indicator-input-table meta-input" value="${r.goal||''}" placeholder="-" data-id="${r.id}" data-p="${r.projectName}"></td>
                    ${inputs}
                    <td class="px-4 py-3 text-center"><button class="view-obs-btn ${obsClass}" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-note-sticky"></i></button></td>
                    <td class="px-4 py-3 text-center flex gap-2 justify-center">
                        <button class="edit-btn text-blue-500" data-id="${r.id}"><i class="fa-solid fa-pencil"></i></button>
                        <button class="chart-btn text-[#FF5510]" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-chart-line"></i></button>
                        <button class="del-btn text-red-500" data-id="${r.id}" data-p="${r.projectName}"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                els.tableBody.appendChild(tr);
            });

            els.tableBody.querySelectorAll('select').forEach(el => el.addEventListener('change', updateStatus));
            els.tableBody.querySelectorAll('.indicator-input-table:not(.meta-input)').forEach(el => el.addEventListener('change', updateIndicator)); 
            els.tableBody.querySelectorAll('.meta-input').forEach(el => el.addEventListener('change', updateMeta));
            els.tableBody.querySelectorAll('.view-obs-btn').forEach(el => el.addEventListener('click', openObs));
            els.tableBody.querySelectorAll('.chart-btn').forEach(el => el.addEventListener('click', openChart));
            els.tableBody.querySelectorAll('.del-btn').forEach(el => el.addEventListener('click', confirmDel));
            els.tableBody.querySelectorAll('.edit-btn').forEach(el => el.addEventListener('click', editStore));
        }

        function updateGeneric(id, pName, fn) {
            const clone = JSON.parse(JSON.stringify(allStoresData));
            const idx = clone.findIndex(s => s && s.id === id);
            if(idx > -1 && clone[idx].projects[pName]) {
                fn(clone[idx].projects[pName]);
                saveToFirebase(clone);
            }
        }

        function updateStatus(e) {
            const el = e.target;
            updateGeneric(el.dataset.id, el.dataset.p, (proj) => proj.status = el.value);
            el.className = `status-select ${statusList.find(s=>s.val===el.value)?.cls||'status-default'} text-xs`;
        }

        function updateIndicator(e) {
            const el = e.target;
            updateGeneric(el.dataset.id, el.dataset.p, (proj) => {
                if(!proj.indicators) proj.indicators = {};
                proj.indicators[el.dataset.m] = el.value;
            });
            flash(el);
        }

        function updateMeta(e) {
            const el = e.target;
            updateGeneric(el.dataset.id, el.dataset.p, (proj) => proj.goal = el.value);
            flash(el);
        }

        function flash(el) {
            el.classList.add('bg-green-100', 'border-green-500');
            setTimeout(() => el.classList.remove('bg-green-100', 'border-green-500'), 1000);
        }

        els.storeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            document.getElementById('save-store-btn').disabled = true;
            const data = new FormData(els.storeForm);
            const id = data.get('cnpj');
            const clone = JSON.parse(JSON.stringify(allStoresData));
            let idx = clone.findIndex(s => s && s.id === id);
            
            const common = {
                analista: data.get('analista'), anjo: data.get('anjo'), uf: data.get('uf'),
                bandeira: data.get('bandeira'), ge: data.get('ge'), associado: data.get('associado'),
                nomeLoja: data.get('nome-loja')
            };

            if(document.getElementById('cnpj').readOnly) { 
                 if(idx > -1) clone[idx] = { ...clone[idx], ...common };
            } else { 
                const pName = data.get('nome-projeto');
                if(!id || !pName) { showToast("CNPJ e Projeto obrigatórios", true); document.getElementById('save-store-btn').disabled=false; return; }
                const newProj = { status: 'pendente', goal: data.get('meta'), observation: data.get('observation'), indicators: {} };
                indicatorMonths.forEach(m => newProj.indicators[m.id] = '');
                
                if(idx > -1) {
                    clone[idx] = { ...clone[idx], ...common };
                    if(!clone[idx].projects) clone[idx].projects = {};
                    clone[idx].projects[pName] = newProj;
                } else {
                    clone.push({ ...common, id: id, projects: { [pName]: newProj } });
                }
            }
            saveToFirebase(clone);
            hide(els.storeModal);
            document.getElementById('save-store-btn').disabled = false;
        });

        function calcKPIs() {
            const k = { total: new Set(), pend: 0, assoc: 0, fin: 0, and: 0 };
            allFlattenedData.forEach(r => {
                k.total.add(r.id);
                if(r.status === 'pendente') k.pend++;
                else if(r.status === 'pendente-associa') k.assoc++;
                else if(r.status === 'finalizado') k.fin++;
                else if(r.status === 'andamento') k.and++;
            });
            els.kpis.total.textContent = k.total.size;
            els.kpis.pendente.textContent = k.pend;
            els.kpis.associa.textContent = k.assoc;
            els.kpis.finalizado.textContent = k.fin;
            els.kpis.andamento.textContent = k.and;
        }

        function showToast(msg, err, duration=3000) {
            els.toast.textContent = msg;
            els.toast.className = `fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg z-50 transform transition-all duration-300 ${err?'bg-red-600':'bg-green-600'} translate-x-0 opacity-100`;
            setTimeout(() => els.toast.classList.add('translate-x-full', 'opacity-0'), duration);
        }

        function openObs(e) {
            const {id, p} = e.currentTarget.dataset;
            const row = allFlattenedData.find(r => r.id === id && r.projectName === p);
            document.getElementById('obs-modal-textarea').value = row?.observation || '';
            document.getElementById('save-obs-btn').onclick = () => {
                updateGeneric(id, p, (pr) => pr.observation = document.getElementById('obs-modal-textarea').value);
                hide(els.obsModal);
            };
            show(els.obsModal);
        }

        function confirmDel(e) {
            const {id, p} = e.currentTarget.dataset;
            document.getElementById('confirm-delete-btn').onclick = () => {
                const clone = JSON.parse(JSON.stringify(allStoresData));
                const idx = clone.findIndex(s => s && s.id === id);
                if(idx > -1) {
                    delete clone[idx].projects[p];
                    saveToFirebase(clone);
                }
                hide(els.deleteModal);
            };
            show(els.deleteModal);
        }

        function editStore(e) {
            const id = e.currentTarget.dataset.id;
            const d = allFlattenedData.find(r => r.id === id);
            if(!d) return;
            ['nome-loja','analista','ge','associado','bandeira','uf','anjo'].forEach(f => {
                const input = document.getElementsByName(f)[0];
                if(input) input.value = d[f==='nome-loja'?'nomeLoja':f]||'';
            });
            document.getElementById('cnpj').value = id; document.getElementById('cnpj').readOnly = true;
            document.getElementById('store-modal-title').textContent = "Editar Loja";
            document.getElementById('form-project-group').style.display = 'none';
            document.getElementById('form-meta-group').style.display = 'none';
            document.getElementById('form-observation-group').style.display = 'none';
            document.getElementById('nome-projeto').required = false;
            show(els.storeModal);
        }

        function openChart(e) {
            const {id, p} = e.currentTarget.dataset;
            currentChartRowData = allFlattenedData.find(r => r.id === id && r.projectName === p);
            renderChart('number');
            show(els.chartModal);
        }

        function renderChart(fmt) {
            if(!currentChartRowData) return;
            const ctx = document.getElementById('indicator-chart').getContext('2d');
            if(currentChartInstance) currentChartInstance.destroy();
            const data = indicatorMonths.map(m => Number(currentChartRowData.indicators?.[m.id]) || 0);
            const goal = Number(currentChartRowData.goal) || 0;
            
            currentChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: [{ label: 'Realizado', data, borderColor: '#FF5510', backgroundColor: 'rgba(255,85,16,0.1)', fill: true, tension: 0.1 }] },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { 
                        annotation: { annotations: { line1: { type: 'line', yMin: goal, yMax: goal, borderColor: 'red', borderWidth: 2, borderDash: [5,5], label: { enabled: true, content: 'Meta: '+goal } } } }
                    }
                }
            });
        }
        
        document.getElementById('generate-chart-btn').addEventListener('click', () => {
             const proj = document.getElementById('chart-filter-project').value;
             const ge = document.getElementById('chart-filter-ge').value;
             const term = document.getElementById('chart-filter-cnpj-loja').value.toLowerCase();
             if(!proj) { showToast("Selecione um projeto", true); return; }

             const rows = allFlattenedData.filter(r => r.projectName === proj && (!ge || r.ge === ge) && (!term || r.nomeLoja.toLowerCase().includes(term) || r.id.includes(term)));
             const ctx = document.getElementById('consolidated-chart').getContext('2d');
             if(consolidatedChartInstance) consolidatedChartInstance.destroy();
             
             consolidatedChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: rows.map(r => ({
                        label: r.nomeLoja,
                        data: indicatorMonths.map(m => Number(r.indicators?.[m.id])||0),
                        borderColor: '#'+Math.floor(Math.random()*16777215).toString(16),
                        tension: 0.1, fill: false
                    }))
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
             });
        });

        const show = (el) => el.classList.remove('hidden');
        const hide = (el) => el.classList.add('hidden');
        const saveFilters = () => localStorage.setItem('filters', JSON.stringify(Object.fromEntries(Object.entries(els.filters).map(([k,v]) => [k, v ? v.value : '']))));
        const loadFilters = () => { const f = JSON.parse(localStorage.getItem('filters')); if(f) Object.entries(f).forEach(([k,v]) => { if(els.filters[k]) els.filters[k].value = v; }); };
        
        document.getElementById('open-modal-btn').onclick = () => {
            els.storeForm.reset(); document.getElementById('cnpj').readOnly = false;
            document.getElementById('store-modal-title').textContent = "Nova Loja";
            document.getElementById('form-project-group').style.display = 'block';
            document.getElementById('form-meta-group').style.display = 'block';
            document.getElementById('form-observation-group').style.display = 'block';
            document.getElementById('nome-projeto').required = true;
            initDropdowns();
            show(els.storeModal);
        };
        ['close-modal-btn','cancel-modal-btn'].forEach(id => document.getElementById(id).onclick = () => hide(els.storeModal));
        document.getElementById('close-chart-modal-btn').onclick = () => hide(els.chartModal);
        ['cancel-obs-btn','close-obs-modal-btn'].forEach(id => document.getElementById(id).onclick = () => hide(els.obsModal));
        document.getElementById('cancel-delete-btn').onclick = () => hide(els.deleteModal);
        document.getElementById('toggle-
