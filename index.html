<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado Farmarcas - Sincronizado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .nav-btn { padding: 0.75rem 1.5rem; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s; cursor: pointer; color: #64748b; }
        .nav-btn:hover { color: #FF5510; background-color: #fff1eb; }
        .nav-btn.active { border-bottom-color: #FF5510; color: #FF5510; background-color: #fff; }
        .hidden-view { display: none !important; }
        /* Utilitários Dashboard 2 */
        .status-select { padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-weight: 500; appearance: none; -webkit-appearance: none; background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e") no-repeat right 8px center / 14px; }
        .status-default { background-color: #f3f4f6; color: #4b5563; }
        .status-pendente { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-andamento { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .status-pendente-associa { background-color: #fef9c3; color: #a16207; border-color: #fde047; }
        .status-finalizado { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .indicator-input-table { width: 70px; padding: 4px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; background-color: #f9fafb; transition: all 0.2s; }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALfPIUw9lc_zkHlSZ6Y2xRdcTu0awhdzM",
            authDomain: "dashboardprojetos-a749c.firebaseapp.com",
            databaseURL: "https://dashboardprojetos-a749c-default-rtdb.firebaseio.com",
            projectId: "dashboardprojetos-a749c",
            storageBucket: "dashboardprojetos-a749c.firebasestorage.app",
            messagingSenderId: "208429748638",
            appId: "1:208429748638:web:9d5ee72514035221b3c68f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Expor para o escopo global (para o React e Vanilla JS acessarem)
        window.FB_DB = db;
        window.FB_REF = ref;
        window.FB_SET = set;
        window.FB_ONVALUE = onValue;

        // Disparar evento para avisar o React que o Firebase está pronto
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <div class="w-8 h-8 bg-[#FF5510] rounded-lg flex items-center justify-center text-white font-bold"><i class="fa-solid fa-layer-group"></i></div>
                        <span class="font-bold text-xl tracking-tight text-slate-800">Sistema Integrado</span>
                    </div>
                    <div class="hidden md:flex ml-10 space-x-1">
                        <button id="nav-contingencia" class="nav-btn active" onclick="switchTab('contingencia')">Painel de Contingência (Firebase)</button>
                        <button id="nav-projetos" class="nav-btn" onclick="switchTab('projetos')">Dashboard Projetos (Firebase)</button>
                    </div>
                </div>
                <div id="sync-status" class="flex items-center text-xs text-green-600 font-bold px-3"><i class="fa-solid fa-circle text-[8px] mr-2"></i>Conectado</div>
            </div>
        </div>
    </nav>

    <div id="view-contingencia" class="view-section">
        <div id="root"></div>
    </div>

    <div id="view-projetos" class="view-section hidden-view">
        <aside id="filter-sidebar" class="fixed top-16 left-0 z-30 w-72 h-[calc(100vh-64px)] bg-white shadow-lg p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300 overflow-y-auto border-r border-slate-200">
            <h3 class="text-xl font-extrabold text-gray-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-filter text-[#FF5510]"></i> Filtros</h3>
            <div class="space-y-4 pr-2">
                <div><label class="block text-sm font-medium text-gray-700">Analista</label><select id="filter-analista" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="filter-projeto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Busca</label><input type="text" id="filter-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Loja, CNPJ..."></div>
            </div>
            <div class="mt-6 space-y-3">
                <button id="apply-filters-btn" class="w-full bg-[#FF5510] text-white py-2 rounded-lg font-semibold hover:bg-[#E04A0E] transition shadow-sm">Aplicar</button>
                <button id="clear-filters-btn" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition">Limpar</button>
            </div>
        </aside>

        <main id="main-content" class="md:ml-72 transition-all duration-300 p-6 min-h-screen bg-gray-50/50">
            <header class="mb-6">
                <div class="flex justify-between items-center mb-6">
                    <button id="toggle-filter-btn" class="md:hidden mr-4 text-gray-600"><i class="fa-solid fa-bars fa-lg"></i></button>
                    <button id="open-modal-btn" class="bg-[#FF5510] text-white py-2 px-5 rounded-lg font-semibold hover:bg-[#E04A0E] flex items-center space-x-2 shadow-sm"><i class="fa-solid fa-plus"></i><span>Nova Loja</span></button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-black"><h4 class="text-xs font-bold text-gray-500 uppercase">Total</h4><p id="kpi-total-lojas" class="text-2xl font-extrabold text-gray-900">0</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"><h4 class="text-xs font-bold text-gray-500 uppercase">Pendente</h4><p id="kpi-projetos-pendentes" class="text-2xl font-extrabold text-gray-900">0</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500"><h4 class="text-xs font-bold text-gray-500 uppercase">Andamento</h4><p id="kpi-em-andamento" class="text-2xl font-extrabold text-gray-900">0</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500"><h4 class="text-xs font-bold text-gray-500 uppercase">Finalizado</h4><p id="kpi-projetos-finalizados" class="text-2xl font-extrabold text-gray-900">0</p></div>
                </div>
            </header>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Loja</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">CNPJ</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Analista</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Projeto</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Meta</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed top-20 right-6 p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 z-[60]">Msg</div>
    <div id="store-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <header class="p-6 border-b bg-gray-50 flex justify-between"><h2 class="text-xl font-bold">Gerenciar Loja</h2><button id="close-modal-btn" class="text-gray-400"><i class="fa-solid fa-times"></i></button></header>
            <form id="store-form" class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Nome Loja</label><input type="text" name="nome-loja" required class="w-full border rounded p-2"></div>
                    <div><label class="block text-sm font-medium">CNPJ (ID)</label><input type="text" id="cnpj" name="cnpj" required class="w-full border rounded p-2"></div>
                    <div><label class="block text-sm font-medium">Analista</label><input type="text" name="analista" class="w-full border rounded p-2"></div>
                    <div><label class="block text-sm font-medium">GE</label><input type="text" name="ge" class="w-full border rounded p-2"></div>
                </div>
                <div><label class="block text-sm font-medium">Projeto</label><select id="nome-projeto" name="nome-projeto" required class="w-full border rounded p-2 bg-white"></select></div>
                <div><label class="block text-sm font-medium">Meta</label><input type="number" name="meta" class="w-full border rounded p-2"></div>
            </form>
            <footer class="p-6 border-t bg-gray-50 flex justify-end"><button id="save-store-btn" type="submit" form="store-form" class="bg-[#FF5510] text-white px-5 py-2 rounded-lg">Salvar</button></footer>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(view => view.classList.add('hidden-view'));
            document.getElementById(`view-${tab}`).classList.remove('hidden-view');
        }
    </script>

    <script type="text/babel">
        // Ícones Simplificados
        const IconBase = ({ children, size=18, className="", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const AlertTriangle = (props) => (<IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>);
        const Hammer = (props) => (<IconBase {...props}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V2.75A2.75 2.75 0 0 0 16 0h-2.25c-.85 0-1.66.33-2.25.93L10.25 2.19a3 3 0 0 0-.88 2.12V5.5L13 9"/></IconBase>);
        const CheckCircle2 = (props) => (<IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>);
        const MinusCircle = (props) => (<IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></IconBase>);
        const Save = (props) => (<IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>);
        const XIcon = (props) => (<IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>);
        const Pencil = (props) => (<IconBase {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>);
        const Trash2 = (props) => (<IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>);

        const projectLabels = { mix: "Mix", precificacao: "Preço", pbm: "PBM", pec: "PEC", setorizacao: "Setor.", marcasProprias: "Marcas", gc: "GC", delivery: "Deliv.", inspire: "Inspire", dermaclub: "Derma", servicos: "Serv.", idoso: "Idoso", especiais: "Espec.", fideliza: "Fidel." };
        
        function ContingencyPlan() {
            const [associados, setAssociados] = React.useState([]);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingId, setEditingId] = React.useState(null);
            
            // --- CONEXÃO FIREBASE PARA O REACT ---
            React.useEffect(() => {
                const initFirebase = () => {
                    if (window.FB_DB) {
                        const dbRef = window.FB_REF(window.FB_DB, 'painel_contingencia_v1');
                        window.FB_ONVALUE(dbRef, (snapshot) => {
                            const data = snapshot.val();
                            if (data) {
                                // Converter objeto para array se necessário, ou usar direto se for array
                                const formatted = Array.isArray(data) ? data : Object.values(data);
                                setAssociados(formatted.filter(item => item !== null)); // Remove nulos
                            } else {
                                setAssociados([]);
                            }
                        });
                    }
                };

                // Tenta iniciar se já estiver pronto ou aguarda evento
                if(window.FB_DB) initFirebase();
                else window.addEventListener('firebase-ready', initFirebase);
                
                return () => window.removeEventListener('firebase-ready', initFirebase);
            }, []);

            // Função para salvar no Firebase (substitui LocalStorage)
            const saveToCloud = (newData) => {
                if (window.FB_DB) {
                    const dbRef = window.FB_REF(window.FB_DB, 'painel_contingencia_v1');
                    window.FB_SET(dbRef, newData).catch(err => alert("Erro ao salvar: " + err.message));
                }
            };

            const togglePriorityStatus = (id, projectKey) => {
                const newData = associados.map(item => {
                    if (item.id === id) {
                        const curr = item.projetos[projectKey];
                        const next = curr === 'low_priority' ? 'priority_todo' : 
                                     curr === 'priority_todo' ? 'priority_doing' : 
                                     curr === 'priority_doing' ? 'priority_done' : 'low_priority';
                        return { ...item, projetos: { ...item.projetos, [projectKey]: next } };
                    }
                    return item;
                });
                // O listener do Firebase vai atualizar o estado visual, então só mandamos salvar
                saveToCloud(newData);
            };

            const handleSaveForm = (formData) => {
                let newData;
                if (editingId) {
                    newData = associados.map(item => item.id === editingId ? { ...item, ...formData } : item);
                } else {
                    const newId = associados.length > 0 ? Math.max(...associados.map(a => a.id)) + 1 : 1;
                    const emptyProjects = {};
                    Object.keys(projectLabels).forEach(key => emptyProjects[key] = 'low_priority');
                    newData = [{ id: newId, ...formData, projetos: emptyProjects }, ...associados];
                }
                saveToCloud(newData);
                setIsModalOpen(false);
            };

            const handleDelete = (id) => {
                if (confirm('Excluir loja?')) {
                    const newData = associados.filter(item => item.id !== id);
                    saveToCloud(newData);
                }
            };

            // Renderização Simplificada para caber no código
            return (
                <div className="p-6 pb-20">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-slate-800">Painel de Contingência (Sincronizado)</h1>
                        <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="bg-[#FF5510] text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-bold shadow">+ Adicionar Loja</button>
                    </div>

                    <div className="grid gap-4">
                        {associados.length === 0 && <div className="text-center p-10 bg-white rounded-xl shadow-sm">Nenhum dado encontrado. Adicione uma loja para começar.</div>}
                        {associados.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between mb-4 border-b pb-2">
                                    <div>
                                        <h3 className="font-bold text-lg">{item.loja}</h3>
                                        <span className="text-sm text-slate-500">{item.associado} | CNPJ: {item.cnpj}</span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setEditingId(item.id); setIsModalOpen(true); }} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil size={18}/></button>
                                        <button onClick={() => handleDelete(item.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={18}/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                                    {Object.entries(item.projetos).map(([key, status]) => (
                                        <div key={key} onClick={() => togglePriorityStatus(item.id, key)} 
                                            className={`p-2 rounded text-xs cursor-pointer border flex items-center gap-1 select-none transition-colors
                                            ${status==='priority_done' ? 'bg-emerald-100 border-emerald-300 text-emerald-800' : 
                                              status==='priority_doing' ? 'bg-orange-100 border-orange-300 text-orange-800' :
                                              status==='priority_todo' ? 'bg-red-100 border-red-300 text-red-800' : 'bg-slate-50 text-slate-400'}`}>
                                            {status==='priority_done' ? <CheckCircle2 size={12}/> : status==='priority_doing' ? <Hammer size={12}/> : status==='priority_todo' ? <AlertTriangle size={12}/> : <MinusCircle size={12}/>}
                                            <span className="truncate">{projectLabels[key]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Modal React Integrado */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                                <h3 className="font-bold text-lg mb-4">{editingId ? 'Editar' : 'Nova Loja'}</h3>
                                <StoreForm onSave={handleSaveForm} onClose={() => setIsModalOpen(false)} 
                                    initialData={editingId ? associados.find(a => a.id === editingId) : { associado: '', loja: '', ge: '', cnpj: '' }} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const StoreForm = ({ onSave, onClose, initialData }) => {
            const [formData, setFormData] = React.useState(initialData);
            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            return (
                <form onSubmit={(e) => { e.preventDefault(); onSave(formData); }} className="space-y-3">
                    <input name="associado" placeholder="Associado" value={formData.associado} onChange={handleChange} required className="w-full border p-2 rounded" />
                    <input name="loja" placeholder="Loja" value={formData.loja} onChange={handleChange} required className="w-full border p-2 rounded" />
                    <input name="ge" placeholder="GE" value={formData.ge} onChange={handleChange} className="w-full border p-2 rounded" />
                    <input name="cnpj" placeholder="CNPJ" value={formData.cnpj} onChange={handleChange} className="w-full border p-2 rounded" />
                    <div className="flex justify-end gap-2 mt-4">
                        <button type="button" onClick={onClose} className="px-4 py-2 border rounded">Cancelar</button>
                        <button type="submit" className="px-4 py-2 bg-[#FF5510] text-white rounded">Salvar</button>
                    </div>
                </form>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContingencyPlan />);
    </script>

    <script>
        const projectList = ["MIX", "PRECIFICAÇÃO", "PBM", "PEC", "SETORIZAÇÃO", "MARCAS PROPRIAS", "GC", "DELIVERY", "INSPIRE +", "DERMACLUB", "SERVIÇOS", "IDOSO", "ESPECIAIS", "FIDELIZA"];
        let allStoresData = []; 
        let allFlattenedData = [];

        // Aguarda o Firebase Global estar pronto
        const startDashboard = () => {
            if (!window.FB_REF) return setTimeout(startDashboard, 100);
            
            // Popula Dropdowns
            const pSelect = document.getElementById('filter-projeto');
            const modalSelect = document.getElementById('nome-projeto');
            projectList.forEach(p => {
                pSelect.add(new Option(p, p));
                modalSelect.add(new Option(p, p));
            });
            pSelect.insertBefore(new Option("Todos", ""), pSelect.firstChild);
            pSelect.value = "";

            // Listener do Firebase (Dashboard 2 usa o nó 'dashboard_projetos_v1')
            const dbRef = window.FB_REF(window.FB_DB, 'dashboard_projetos_v1');
            window.FB_ONVALUE(dbRef, (snapshot) => {
                const data = snapshot.val();
                allStoresData = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                processData();
            });
        };
        
        window.addEventListener('load', startDashboard);

        // Processamento de Dados
        function processData() {
            allFlattenedData = [];
            const sets = { analistas: new Set(), ges: new Set() };
            let kpis = { total: new Set(), pend: 0, and: 0, fin: 0 };
            
            allStoresData.forEach(store => {
                if(!store) return;
                kpis.total.add(store.id);
                if(store.analista) sets.analistas.add(store.analista);
                if(store.ge) sets.ges.add(store.ge);
                
                if(store.projects) {
                    Object.keys(store.projects).forEach(pName => {
                        const p = store.projects[pName];
                        if(p.status === 'pendente') kpis.pend++;
                        if(p.status === 'andamento') kpis.and++;
                        if(p.status === 'finalizado') kpis.fin++;
                        allFlattenedData.push({ ...store, projectName: pName, ...p });
                    });
                }
            });

            // Atualiza KPIs
            document.getElementById('kpi-total-lojas').innerText = kpis.total.size;
            document.getElementById('kpi-projetos-pendentes').innerText = kpis.pend;
            document.getElementById('kpi-em-andamento').innerText = kpis.and;
            document.getElementById('kpi-projetos-finalizados').innerText = kpis.fin;

            // Renderiza Tabela
            renderTable(allFlattenedData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('project-table-body');
            tbody.innerHTML = '';
            
            // Filtros simples
            const fLoja = document.getElementById('filter-loja').value.toLowerCase();
            const fProj = document.getElementById('filter-projeto').value;
            
            const filtered = data.filter(d => 
                (!fProj || d.projectName === fProj) && 
                (!fLoja || d.nomeLoja.toLowerCase().includes(fLoja) || d.id.includes(fLoja))
            );

            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">Sem dados.</td></tr>';
                return;
            }

            filtered.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                // Status Color
                const cls = r.status === 'finalizado' ? 'bg-green-100 text-green-800' : r.status === 'andamento' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                
                tr.innerHTML = `
                    <td class="px-4 py-3">${r.nomeLoja}</td>
                    <td class="px-4 py-3 text-xs text-gray-500">${r.id}</td>
                    <td class="px-4 py-3 text-xs">${r.analista||'-'}</td>
                    <td class="px-4 py-3 font-bold text-xs">${r.projectName}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded text-xs ${cls}">${r.status}</span></td>
                    <td class="px-4 py-3 text-center">${r.goal||'-'}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="text-blue-500 hover:underline text-xs" onclick="editStore('${r.id}')">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Funções de Modal e Salvamento (Simplificadas para caber)
        const modal = document.getElementById('store-modal');
        document.getElementById('open-modal-btn').onclick = () => { 
            document.getElementById('store-form').reset(); 
            document.getElementById('cnpj').readOnly = false;
            modal.classList.remove('hidden'); 
        };
        document.getElementById('close-modal-btn').onclick = () => modal.classList.add('hidden');

        document.getElementById('store-form').onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('cnpj');
            const pName = fd.get('nome-projeto');
            
            // Clona dados atuais
            const clone = JSON.parse(JSON.stringify(allStoresData));
            let idx = clone.findIndex(s => s && s.id === id);
            
            const common = { nomeLoja: fd.get('nome-loja'), analista: fd.get('analista'), ge: fd.get('ge') };
            const newProj = { status: 'pendente', goal: fd.get('meta') };

            if(idx > -1) {
                clone[idx] = { ...clone[idx], ...common };
                if(!clone[idx].projects) clone[idx].projects = {};
                clone[idx].projects[pName] = newProj;
            } else {
                clone.push({ ...common, id: id, projects: { [pName]: newProj } });
            }

            // Salva no Firebase
            const dbRef = window.FB_REF(window.FB_DB, 'dashboard_projetos_v1');
            window.FB_SET(dbRef, clone);
            modal.classList.add('hidden');
        };

        // Filtros Events
        document.getElementById('apply-filters-btn').onclick = processData;
        document.getElementById('filter-loja').oninput = processData;
    </script>
</body>
</html>
