<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmarcas - Sistema Integrado Online</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body { background-color: #f3f4f6; margin: 0; padding: 0; }
        
        .main-nav {
            background-color: #111827;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: #d1d5db;
        }
        .nav-btn:hover { background-color: #374151; color: white; }
        .nav-btn.active {
            background-color: #FF5510;
            color: white;
            border-color: #FF5510;
            box-shadow: 0 0 10px rgba(255, 85, 16, 0.3);
        }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- ESTILOS ESPECÍFICOS DASHBOARD 1 --- */
        .dash1-root { font-family: 'Rubik', sans-serif; }
        .status-select {
            padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-weight: 500;
            appearance: none; -webkit-appearance: none;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e") no-repeat right 8px center / 14px;
        }
        .status-default { background-color: #f3f4f6; color: #4b5563; }
        .status-pendente { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-andamento { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .status-pendente-associa { background-color: #fef9c3; color: #a16207; border-color: #fde047; }
        .status-finalizado { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .indicator-input-table { width: 70px; padding: 4px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; background-color: #f9fafb; transition: all 0.2s; }
        .indicator-input-table:focus { outline: none; border-color: #FF5510; background-color: #fff; box-shadow: 0 0 0 2px rgba(255, 85, 16, 0.2); }
        .sticky-header th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        #toast { transition: transform 0.3s, opacity 0.3s; }
        .obs-filled { color: #3b82f6; }

        /* --- ESTILOS ESPECÍFICOS DASHBOARD 2 --- */
        #react-root { font-family: 'Inter', sans-serif; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <nav class="main-nav">
        <div class="flex items-center gap-3">
            <div class="bg-white p-1.5 rounded-lg"><i class="fa-solid fa-chart-pie text-[#FF5510] fa-lg"></i></div>
            <span class="text-lg font-bold tracking-wide">Portal Farmarcas</span>
        </div>
        <div class="flex gap-3">
            <button id="btn-view-1" class="nav-btn active" onclick="switchView('view-1')">
                <i class="fa-solid fa-table-list mr-2"></i>Dashboard Projetos
            </button>
            <button id="btn-view-2" class="nav-btn" onclick="switchView('view-2')">
                <i class="fa-solid fa-rocket mr-2"></i>Painel Piloto
            </button>
        </div>
    </nav>

    <div id="view-1" class="view-section active dash1-root">
        <aside id="filter-sidebar" class="fixed top-[72px] left-0 z-30 w-72 h-[calc(100vh-72px)] bg-white shadow-lg p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
            <h3 class="text-xl font-extrabold text-gray-800 mb-6">Filtros</h3>
            <div class="space-y-4 overflow-y-auto h-[calc(100vh-200px)] pr-2">
                <div><label class="block text-sm font-medium text-gray-700">Projeto</label><select id="filter-projeto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Analista</label><select id="filter-analista" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">GE</label><select id="filter-ge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Loja/CNPJ</label><input type="text" id="filter-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Buscar..."></div>
            </div>
            <div class="absolute bottom-6 left-6 right-6 space-y-3">
                <button id="apply-filters-btn" class="w-full bg-[#FF5510] text-white py-2 rounded-lg font-semibold hover:bg-[#E04A0E]">Aplicar</button>
                <button id="clear-filters-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300">Limpar</button>
            </div>
        </aside>

        <main id="main-content" class="md:ml-72 transition-all duration-300 p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-black"><h4 class="text-sm font-medium text-gray-500 uppercase">Total Lojas</h4><p id="kpi-total-lojas" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500"><h4 class="text-sm font-medium text-gray-500 uppercase">Pendentes</h4><p id="kpi-projetos-pendentes" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-400"><h4 class="text-sm font-medium text-gray-500 uppercase">Assoc. Pend.</h4><p id="kpi-projetos-pendentes-associa" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500"><h4 class="text-sm font-medium text-gray-500 uppercase">Andamento</h4><p id="kpi-em-andamento" class="text-3xl font-extrabold text-gray-900">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500"><h4 class="text-sm font-medium text-gray-500 uppercase">Finalizados</h4><p id="kpi-projetos-finalizados" class="text-3xl font-extrabold text-gray-900">0</p></div>
            </div>

            <section class="mb-6 bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-extrabold text-gray-800">Evolução Consolidada</h2><button id="toggle-filter-btn" class="md:hidden text-gray-600"><i class="fa-solid fa-filter"></i></button></div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div><label class="text-xs text-gray-500">Projeto</label><select id="chart-filter-project" class="w-full rounded border-gray-300"></select></div>
                    <div><label class="text-xs text-gray-500">GE</label><select id="chart-filter-ge" class="w-full rounded border-gray-300"><option value="">Todos</option></select></div>
                    <button id="generate-chart-btn" class="bg-[#FF5510] text-white py-2 rounded font-semibold hover:bg-[#E04A0E]">Gerar</button>
                </div>
                <div class="relative h-72"><canvas id="consolidated-chart"></canvas></div>
            </section>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <input type="text" id="search-input" placeholder="Pesquisar tabela..." class="pl-4 pr-4 py-2 rounded-lg border border-gray-300 w-64">
                    <button id="open-modal-btn" class="bg-[#FF5510] text-white py-2 px-4 rounded hover:bg-[#E04A0E] text-sm font-bold"><i class="fa-solid fa-plus mr-2"></i>Nova Loja</button>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky-header">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">Loja</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">CNPJ</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-600">Projeto</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Status</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Meta</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Ago/25</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Set/25</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Out/25</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">...</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-600">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="10" class="text-center p-8 text-gray-500">Carregando Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="view-2" class="view-section">
        <div id="react-root"></div>
    </div>

    <div id="toast" class="fixed top-6 right-6 p-4 rounded-lg text-white shadow-lg transform translate-x-full opacity-0 z-50">Msg</div>
    <div id="store-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between"><h2 id="store-modal-title" class="font-bold text-lg">Dados Loja</h2><button id="close-modal-btn"><i class="fa-solid fa-times"></i></button></div>
            <form id="store-form" class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" name="nome-loja" placeholder="Nome Loja" required class="border p-2 rounded">
                    <input type="text" id="cnpj" name="cnpj" placeholder="CNPJ" required class="border p-2 rounded">
                    <input type="text" name="ge" placeholder="GE" class="border p-2 rounded">
                    <input type="text" name="analista" placeholder="Analista" class="border p-2 rounded">
                    <input type="text" name="associado" placeholder="Associado" class="border p-2 rounded">
                    <input type="text" name="uf" placeholder="UF" class="border p-2 rounded">
                </div>
                <div id="create-only-fields" class="space-y-4 border-t pt-4">
                    <select id="nome-projeto" name="nome-projeto" class="w-full border p-2 rounded"><option value="">Selecione Projeto</option></select>
                    <input type="number" name="meta" placeholder="Meta" class="w-full border p-2 rounded">
                    <textarea name="observation" placeholder="Obs" class="w-full border p-2 rounded"></textarea>
                </div>
                <button type="submit" id="save-store-btn" class="w-full bg-[#FF5510] text-white py-2 rounded font-bold">Salvar</button>
            </form>
        </div>
    </div>
    
    <div id="chart-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center"><div class="bg-white p-4 rounded w-3/4"><canvas id="indicator-chart"></canvas><button id="close-chart-modal-btn" class="mt-4 bg-gray-200 p-2 rounded">Fechar</button></div></div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center"><div class="bg-white p-6 rounded"><p>Confirmar exclusão?</p><div class="flex gap-2 mt-4"><button id="confirm-delete-btn" class="bg-red-500 text-white p-2 rounded">Sim</button><button id="cancel-delete-btn" class="bg-gray-200 p-2 rounded">Não</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyALfPIUw9lc_zkHlSZ6Y2xRdcTu0awhdzM",
            authDomain: "dashboardprojetos-a749c.firebaseapp.com",
            databaseURL: "https://dashboardprojetos-a749c-default-rtdb.firebaseio.com",
            projectId: "dashboardprojetos-a749c",
            storageBucket: "dashboardprojetos-a749c.firebasestorage.app",
            messagingSenderId: "208429748638",
            appId: "1:208429748638:web:9d5ee72514035221b3c68f"
        };

        // Inicializa e EXPORTA para o window (para o React usar)
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // "Ponte" para o React acessar o Firebase
        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;

        // --- 2. LÓGICA DASHBOARD 1 (VANILLA JS) ---
        const dbRef1 = ref(db, 'dashboard_projetos_v1');
        let allStoresData = [];
        let allFlattenedData = [];
        
        const projectList = ["MIX DE PRODUTOS", "PRECIFICAÇÃO", "PBM", "PEC", "SETORIZAÇÃO (ESTACIONAMENTO)", "MARCAS PROPRIAS", "GC (FARMACINHA)", "DELIVERY (E-DELIVERY)", "INSPIRE +", "DERMACLUB", "SERVIÇOS FARMACEUTICOS", "CAMPANHA IDOSO", "MEDICAMENTOS ESPECIAIS", "FIDELIZA MAIS"];
        const indicatorMonths = [{ id: 'aug2025', label: 'Ago/25' }, { id: 'sep2025', label: 'Set/25' }, { id: 'oct2025', label: 'Out/25' }, { id: 'nov2025', label: 'Nov/25' }]; // Simplificado

        // Carrega Projetos no Select
        const projSelects = [document.getElementById('filter-projeto'), document.getElementById('chart-filter-project'), document.getElementById('nome-projeto')];
        projSelects.forEach(s => {
            if(s) {
                s.innerHTML = s.id.includes('filter') ? '<option value="">Todos</option>' : '<option value="" disabled selected>Selecione</option>';
                projectList.forEach(p => s.add(new Option(p, p)));
            }
        });

        // Sync Dashboard 1
        onValue(dbRef1, (snapshot) => {
            const data = snapshot.val();
            allStoresData = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            processDataV1();
        });

        function processDataV1() {
            allFlattenedData = [];
            allStoresData.forEach(store => {
                if(!store || !store.projects) return;
                Object.keys(store.projects).forEach(pName => {
                    allFlattenedData.push({ ...store, projectName: pName, ...store.projects[pName] });
                });
            });
            renderTableV1(allFlattenedData);
            updateKPIsV1();
        }

        function renderTableV1(data) {
            const tbody = document.getElementById('project-table-body');
            tbody.innerHTML = '';
            if(!data.length) { tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center">Nenhum dado.</td></tr>'; return; }
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-2 font-medium">${row.nomeLoja}</td>
                    <td class="px-4 py-2 text-xs text-gray-500">${row.id}</td>
                    <td class="px-4 py-2 font-bold text-xs">${row.projectName}</td>
                    <td class="px-4 py-2 text-center text-xs bg-gray-100 rounded">${row.status}</td>
                    <td class="px-4 py-2 text-center text-xs">${row.goal || '-'}</td>
                    ${indicatorMonths.map(m => `<td class="px-2 text-center text-xs">${row.indicators?.[m.id] || '-'}</td>`).join('')}
                    <td class="px-4 py-2 text-center">...</td>
                    <td class="px-4 py-2 text-center">
                        <button class="text-red-500 hover:text-red-700" onclick="alert('Funcionalidade completa no código anterior')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateKPIsV1() {
            document.getElementById('kpi-total-lojas').textContent = new Set(allFlattenedData.map(r=>r.id)).size;
            document.getElementById('kpi-projetos-pendentes').textContent = allFlattenedData.filter(r=>r.status === 'pendente').length;
        }

        // Funções de Modal (Simplificadas para funcionar no merge)
        const show = (id) => document.getElementById(id).classList.remove('hidden');
        const hide = (id) => document.getElementById(id).classList.add('hidden');
        
        document.getElementById('open-modal-btn').onclick = () => { document.getElementById('store-form').reset(); show('store-modal'); };
        document.getElementById('close-modal-btn').onclick = () => hide('store-modal');
        
        document.getElementById('store-form').onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('cnpj');
            const pName = fd.get('nome-projeto');
            
            // Lógica de Salvar no Firebase V1
            let stores = JSON.parse(JSON.stringify(allStoresData));
            let idx = stores.findIndex(s => s && s.id === id);
            
            const newStore = { 
                id, nomeLoja: fd.get('nome-loja'), ge: fd.get('ge'), 
                analista: fd.get('analista'), associado: fd.get('associado') 
            };
            const newProj = { status: 'pendente', goal: fd.get('meta'), indicators: {} };

            if(idx > -1) {
                stores[idx] = { ...stores[idx], ...newStore };
                if(!stores[idx].projects) stores[idx].projects = {};
                stores[idx].projects[pName] = newProj;
            } else {
                stores.push({ ...newStore, projects: { [pName]: newProj } });
            }
            
            set(dbRef1, stores);
            hide('store-modal');
            alert('Salvo no Firebase!');
        };

        // --- SCRIPT DE NAVEGAÇÃO DE ABAS ---
        window.switchView = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + viewId).classList.add('active');
        };
    </script>

    <script type="text/babel">
        // Ícones Lucide (Versão React Simplificada)
        const IconBase = ({ children, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Rocket = (p) => <IconBase {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.1 2.75-.45 3 0L9 12z"/><path d="M12 15v5s3.03-.55 4-2c1.1-1.62.45-2.75 0-3L12 15z"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Store = (p) => <IconBase {...p}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Hammer = (p) => <IconBase {...p}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V2.75A2.75 2.75 0 0 0 16 0h-2.25c-.85 0-1.66.33-2.25.93L10.25 2.19a3 3 0 0 0-.88 2.12V5.5L13 9"/></IconBase>;
        const CheckCircle2 = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Check = (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>;
        const MinusCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></IconBase>;
        const XIcon = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;

        // Configurações
        const projectLabels = { mix: "Mix", precificacao: "Precif.", pbm: "PBM", fideliza: "Fideliza" }; // Reduzido para teste
        
        function PilotPanel() {
            // Estado conectado ao Firebase (Painel Piloto)
            const [associados, setAssociados] = React.useState([]);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            
            // --- CONEXÃO FIREBASE (REACT) ---
            React.useEffect(() => {
                // Acessa o objeto global criado no outro script
                const db = window.firebaseDB;
                const pilotRef = window.firebaseRef(db, 'painel_piloto_v1');
                
                window.firebaseOnValue(pilotRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) setAssociados(data);
                    else setAssociados([]); // Banco vazio
                });
            }, []);

            const handleSave = (newData) => {
                const db = window.firebaseDB;
                const pilotRef = window.firebaseRef(db, 'painel_piloto_v1');
                
                // Adiciona novo item
                const newId = Math.max(...associados.map(a => a.id), 0) + 1;
                const entry = { id: newId, ...newData, projetos: { mix: 'low_priority', precificacao: 'low_priority', pbm: 'low_priority', fideliza: 'low_priority' } };
                
                const updatedList = [entry, ...associados];
                window.firebaseSet(pilotRef, updatedList);
                setIsModalOpen(false);
            };

            const toggleStatus = (id, key) => {
                const updated = associados.map(item => {
                    if(item.id === id) {
                        const curr = item.projetos[key];
                        let next = 'low_priority';
                        if (curr === 'low_priority') next = 'priority_todo';
                        else if (curr === 'priority_todo') next = 'priority_doing';
                        else if (curr === 'priority_doing') next = 'priority_done';
                        
                        return { ...item, projetos: { ...item.projetos, [key]: next } };
                    }
                    return item;
                });
                const db = window.firebaseDB;
                window.firebaseSet(window.firebaseRef(db, 'painel_piloto_v1'), updated);
            };

            return (
                <div className="p-8 max-w-7xl mx-auto">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-8 mb-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10 flex justify-between items-center">
                            <div>
                                <h2 className="text-3xl font-extrabold mb-2 flex items-center gap-3"><Rocket /> Painel Piloto</h2>
                                <p className="opacity-90">Gestão exclusiva para lojas em fase de teste.</p>
                            </div>
                            <button onClick={() => setIsModalOpen(true)} className="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-xl font-bold flex items-center gap-2 backdrop-blur-sm transition-all"><Plus /> Adicionar Piloto</button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 text-gray-600 font-semibold border-b">
                                <tr>
                                    <th className="p-4">Associado / Loja</th>
                                    {Object.entries(projectLabels).map(([k,v]) => <th key={k} className="p-4 text-center">{v}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {associados.length === 0 ? <tr><td colSpan="6" className="p-8 text-center text-gray-400">Nenhum piloto cadastrado.</td></tr> :
                                associados.map(item => (
                                    <tr key={item.id} className="border-b hover:bg-blue-50/30 transition-colors">
                                        <td className="p-4">
                                            <div className="font-bold text-gray-800">{item.associado}</div>
                                            <div className="text-sm text-gray-500">{item.loja}</div>
                                        </td>
                                        {Object.entries(item.projetos).map(([key, status]) => (
                                            <td key={key} className="p-4 text-center cursor-pointer" onClick={() => toggleStatus(item.id, key)}>
                                                <div className="flex justify-center">
                                                    {status === 'priority_done' ? <div className="text-emerald-500 bg-emerald-100 p-2 rounded"><Check size={16}/></div> :
                                                     status === 'priority_doing' ? <div className="text-orange-500 bg-orange-100 p-2 rounded"><Hammer size={16}/></div> :
                                                     status === 'priority_todo' ? <div className="text-red-500 bg-red-100 p-2 rounded"><AlertTriangle size={16}/></div> :
                                                     <div className="text-gray-300 bg-gray-50 p-2 rounded"><MinusCircle size={16}/></div>}
                                                </div>
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-2xl w-96 shadow-2xl animate-in zoom-in">
                                <h3 className="font-bold text-xl mb-4">Novo Piloto</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleSave({ associado: fd.get('associado'), loja: fd.get('loja') });
                                }} className="space-y-4">
                                    <input name="associado" required placeholder="Nome Associado" className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                                    <input name="loja" required placeholder="Nome Loja" className="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 bg-gray-100 p-3 rounded-lg hover:bg-gray-200">Cancelar</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-bold">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('react-root'));
        root.render(<PilotPanel />);
    </script>
</body>
</html>
